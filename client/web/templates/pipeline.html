{{define "title"}}Pipeline - RFP Intelligence{{end}}

{{define "content"}}
<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-slate-900">Pipeline</h1>

        <!-- Filters -->
        <form method="GET" class="flex items-center gap-4">
            <select name="user" onchange="this.form.submit()"
                    class="rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                <option value="">All Users</option>
                {{range .Data.Users}}
                <option value="{{.ID}}" {{if eq .ID $.Data.FilterUser}}selected{{end}}>{{.Name}}</option>
                {{end}}
            </select>

            <select name="min_score" onchange="this.form.submit()"
                    class="rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                <option value="">Any Score</option>
                <option value="3" {{if eq $.Data.FilterMinScore 3.0}}selected{{end}}>3.0+</option>
                <option value="3.5" {{if eq $.Data.FilterMinScore 3.5}}selected{{end}}>3.5+</option>
                <option value="4" {{if eq $.Data.FilterMinScore 4.0}}selected{{end}}>4.0+</option>
                <option value="4.5" {{if eq $.Data.FilterMinScore 4.5}}selected{{end}}>4.5+</option>
            </select>

            <label class="flex items-center gap-2 text-sm text-slate-600">
                <input type="checkbox" name="show_ended" value="true" {{if .Data.ShowEnded}}checked{{end}}
                       onchange="this.form.submit()"
                       class="rounded border-slate-300 text-primary-600 focus:ring-primary-500">
                Show completed
            </label>
        </form>
    </div>

    <!-- Active Pipeline -->
    <div class="flex gap-4 overflow-x-auto pb-4">
        {{range .Data.Stages}}
        <div class="flex-shrink-0 w-72">
            <div class="bg-slate-100 rounded-lg p-3">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-semibold text-slate-700">{{.Name}}</h2>
                    <span class="bg-slate-200 text-slate-600 text-xs font-medium px-2 py-0.5 rounded-full">{{.Count}}</span>
                </div>

                <div class="space-y-2 min-h-[200px] pipeline-column" data-stage="{{.ID}}">
                    {{range .RFPs}}
                    <div class="pipeline-card bg-white rounded-lg shadow-sm border border-slate-200 p-3 cursor-move hover:shadow-md transition-shadow"
                         data-rfp-id="{{.ID}}" draggable="true">
                        <div class="flex justify-between items-start mb-2">
                            <a href="/rfps/{{.ID}}" class="text-sm font-medium text-slate-900 hover:text-primary-600 line-clamp-2">
                                {{.Title}}
                            </a>
                            {{if .Score}}
                            <span class="flex-shrink-0 ml-2 text-xs font-semibold px-1.5 py-0.5 rounded
                                {{if ge .Score 4.0}}bg-green-100 text-green-700
                                {{else if ge .Score 3.0}}bg-yellow-100 text-yellow-700
                                {{else}}bg-red-100 text-red-700{{end}}">
                                {{.ScoreDisplay}}
                            </span>
                            {{end}}
                        </div>

                        <p class="text-xs text-slate-500 mb-2">{{.Agency}}</p>

                        <div class="flex justify-between items-center text-xs">
                            <div class="flex items-center gap-2">
                                {{if .DueDate}}
                                <span class="{{if .IsUrgent}}text-red-600 font-medium{{else}}text-slate-500{{end}}">
                                    {{.DueDate}}
                                </span>
                                {{end}}
                                {{if .State}}
                                <span class="text-slate-400">{{.State}}</span>
                                {{end}}
                            </div>

                            {{if .AssigneeInitials}}
                            <span class="w-6 h-6 rounded-full bg-primary-100 text-primary-700 flex items-center justify-center text-xs font-medium"
                                  title="{{.AssigneeName}}">
                                {{.AssigneeInitials}}
                            </span>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}
    </div>

    <!-- Ended Stages -->
    {{if .Data.ShowEnded}}
    <div class="mt-8">
        <h2 class="text-lg font-semibold text-slate-700 mb-4">Completed</h2>
        <div class="flex gap-4 overflow-x-auto pb-4">
            {{range .Data.EndedStages}}
            <div class="flex-shrink-0 w-72">
                <div class="bg-slate-50 rounded-lg p-3 opacity-75">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="font-semibold text-slate-600">{{.Name}}</h2>
                        <span class="bg-slate-200 text-slate-500 text-xs font-medium px-2 py-0.5 rounded-full">{{.Count}}</span>
                    </div>

                    <div class="space-y-2 min-h-[100px] pipeline-column" data-stage="{{.ID}}">
                        {{range .RFPs}}
                        <div class="pipeline-card bg-white rounded-lg shadow-sm border border-slate-200 p-3 cursor-move opacity-75"
                             data-rfp-id="{{.ID}}" draggable="true">
                            <a href="/rfps/{{.ID}}" class="text-sm font-medium text-slate-700 hover:text-primary-600 line-clamp-2">
                                {{.Title}}
                            </a>
                            <p class="text-xs text-slate-500 mt-1">{{.Agency}}</p>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}
</div>

<script>
// Drag and drop functionality
let draggedCard = null;

document.querySelectorAll('.pipeline-card').forEach(card => {
    card.addEventListener('dragstart', (e) => {
        draggedCard = card;
        card.classList.add('opacity-50');
        e.dataTransfer.effectAllowed = 'move';
    });

    card.addEventListener('dragend', () => {
        draggedCard.classList.remove('opacity-50');
        draggedCard = null;
        document.querySelectorAll('.pipeline-column').forEach(col => {
            col.classList.remove('bg-primary-50', 'border-2', 'border-primary-300', 'border-dashed');
        });
    });
});

document.querySelectorAll('.pipeline-column').forEach(column => {
    column.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        column.classList.add('bg-primary-50', 'border-2', 'border-primary-300', 'border-dashed');
    });

    column.addEventListener('dragleave', () => {
        column.classList.remove('bg-primary-50', 'border-2', 'border-primary-300', 'border-dashed');
    });

    column.addEventListener('drop', async (e) => {
        e.preventDefault();
        column.classList.remove('bg-primary-50', 'border-2', 'border-primary-300', 'border-dashed');

        if (!draggedCard) return;

        const rfpId = parseInt(draggedCard.dataset.rfpId);
        const newStage = column.dataset.stage;
        const oldColumn = draggedCard.parentElement;

        if (oldColumn === column) return;

        // Optimistically move the card
        column.appendChild(draggedCard);

        // Update counts
        updateColumnCount(oldColumn);
        updateColumnCount(column);

        try {
            const response = await fetch('/pipeline/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rfp_id: rfpId, stage: newStage })
            });

            if (!response.ok) {
                // Revert on error
                oldColumn.appendChild(draggedCard);
                updateColumnCount(oldColumn);
                updateColumnCount(column);
                alert('Failed to move card');
            }
        } catch (err) {
            // Revert on error
            oldColumn.appendChild(draggedCard);
            updateColumnCount(oldColumn);
            updateColumnCount(column);
            alert('Failed to move card: ' + err.message);
        }
    });
});

function updateColumnCount(column) {
    const countBadge = column.parentElement.querySelector('.rounded-full');
    if (countBadge) {
        const cards = column.querySelectorAll('.pipeline-card');
        countBadge.textContent = cards.length;
    }
}
</script>
{{end}}
